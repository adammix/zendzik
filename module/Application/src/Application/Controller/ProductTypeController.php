<?phpnamespace Application\Controller;use Zend\Mvc\Controller\AbstractActionController;use Zend\View\Model\ViewModel;use Zend\Form\Element;use Application\Entity\ProductTypes;use Application\Entity\Domains;use Application\Entity\Categories;use Application\Entity\Attributes;	use Application\Entity\AttributesGroups;use Application\Entity\Views;use Application\Entity\ViewsDomains;use Application\Form\ProductTypeForm;class ProductTypeController extends AbstractActionController{	protected $_objectManager = null;	    public function indexAction()    {        $product_types = $this->getObjectManager()->getRepository('\Application\Entity\ProductTypes')->findAll();        //die(var_dump($product_types));        return new ViewModel(array('product_types' => $product_types));    }    public function addAction()    {    	$form = new ProductTypeForm();        if($this->request->isPost()){            $name = $this->getRequest()->getPost('name');            $attributes = $this->getRequest()->getPost('attributes');            $domains = $this->getRequest()->getPost('domains');            $is_category = $this->getRequest()->getPost('is_category');            $categories_json = $this->getRequest()->getPost('categories');            //$this->getServiceLocator()->get('log')->info($domains);            /**             * zapis do tablicy ProductType             */            $productType = new ProductTypes();            $productType->setName($name);            $productType->setIsCategory($is_category);            /**             * zapis do tablicy Domains             */            if(!empty($domains)){                $domains_string = '';                end($domains);                $lastKey = key($domains);                foreach($domains as $key => $value){                    if($key == $lastKey){                        $domains_string .= ''.$value;                    }else{                        $domains_string .= $value.';';                    }                }                $productType->setDomains($domains_string);            }            $this->getObjectManager()->persist($productType);            $this->getObjectManager()->flush();            /**             * zapis do tablicy AttributesGroups             */            if(!empty($attributes)){                foreach($attributes as $key => $value){                    $attribute = $this->getObjectManager()->find('\Application\Entity\Attributes', $value);                    if(!empty($attribute)){                        $attributesGroups = new AttributesGroups();                        $attributesGroups->setIdAttributes($attribute)                            ->setIdProductType($productType);                        $this->getObjectManager()->persist($attributesGroups);                    }                }            }            /**             * zapis do tablicy Categories             */            $categories = json_decode($categories_json);            //die(var_dump($categories));            $parent_id = array();            foreach($categories as $category_node){                $category = new Categories();                if($category_node->id == '0'){                    $category   ->setName($category_node->text)                                ->setParentid('0')                                ->setIdproducttypes($productType);                }else{                    $category   ->setName($category_node->text)                                ->setParentid($parent_id[$category_node->parent])                                ->setIdproducttypes($productType);                }                $this->getObjectManager()->persist($category);                $this->getObjectManager()->flush();                $parent_id[$category_node->id] = $category->getId();            }            return $this->redirect()->toRoute('products-type', array());        }				/**		 * ATTRIBUTES		 */		$attributes = $this->getObjectManager()->getRepository('\Application\Entity\Attributes')->findAll();		$attr_options = array();		foreach ($attributes as $key => $value) {			$attr_id = '';			$attr_name = '';			$attr_id = $attributes[$key]->getId();			$attr_name = $attributes[$key]->getName();			$attr_desc = $attributes[$key]->getDescription();			$attr_name = $attr_name.' ('.$attr_desc.')';			$attr_options[$attr_id] = $attr_name;			//$this->getServiceLocator()->get('log')->info($attr_name);		}		$form->get('attributes')->setAttribute('options', $attr_options);				/**		 * DOMAINS		 */		$domains = $this->getObjectManager()->getRepository('\Application\Entity\Domains')->findAll();		$domain_options = array();		foreach ($domains as $key => $value) {			$domain_id = '';			$domain_name = '';			$domain_id = $domains[$key]->getId();			$domain_name = $domains[$key]->getName();						$domain_options[$domain_id] = $domain_name;			//$this->getServiceLocator()->get('log')->info($attr_name);		}		$form->get('domains')->setAttribute('options', $domain_options);        return new ViewModel(array('form' => $form));    }    public function editAction()    {        $form = new ProductTypeForm();        if($this->request->isPost()){            $id = (int)$this->getRequest()->getPost('id');            $name = $this->getRequest()->getPost('name');            $post_attributes = $this->getRequest()->getPost('attributes');            $post_domains = $this->getRequest()->getPost('domains');            $is_category = $this->getRequest()->getPost('is_category');            $categories_json = $this->getRequest()->getPost('categories');            //$this->getServiceLocator()->get('log')->info($domains);            /**             *  zapis NAZWY             */            $product_type = $this->getObjectManager()->getRepository('\Application\Entity\ProductTypes')->findOneById($id);            $product_type->setName($name);            /**             * zapis ATRYBUTÓW             */            $attributes_groups = $this->getObjectManager()->getRepository('\Application\Entity\AttributesGroups')->findBy(array('idProductType' => $id));            foreach ($attributes_groups as $key => $value) {                $attribute = $attributes_groups[$key]->getIdAttributes()->getId();                $is_attribute_exist = array_search($attribute, $post_attributes);                if(isset($is_attribute_exist)){                    unset($post_attributes[$is_attribute_exist]);                }else{                    $this->getObjectManager()->remove($attributes_groups[$key]);                }            }            //$this->getServiceLocator()->get('log')->info($post_attributes);            foreach($post_attributes as $key => $value){                $attribute = $this->getObjectManager()->getRepository('\Application\Entity\Attributes')->findOneById($value);                if(!empty($attribute)){                    $attributesGroups = new AttributesGroups();                    $attributesGroups->setIdAttributes($attribute)                                     ->setIdProductType($product_type);                    $this->getObjectManager()->persist($attributesGroups);                }            }            /**             * zapis DOMEN             */            if(!empty($post_domains)){                $domains_string = '';                end($post_domains);                $lastKey = key($post_domains);                foreach($post_domains as $key => $value){                    if($key == $lastKey){                        $domains_string .= ''.$value;                    }else{                        $domains_string .= $value.';';                    }                }                $product_type->setDomains($domains_string);            }            $this->getObjectManager()->persist($product_type);            $this->getObjectManager()->flush();            /**             * zapis KATEGORII             */            $product_type->setIsCategory($is_category);            if(!empty($categories_json) && !empty($is_category)){                $old_categories = $this->get_categories_tree($product_type , true);                //die(var_dump($old_categories));                $categories = json_decode($categories_json);                $parent_id = array();                foreach($categories as $category_node){                    $category = $this->getObjectManager()->getRepository('\Application\Entity\Categories')->findOneById($category_node->id);                    if($category != NULL){//jeśli kategoria istnieje                        $category->setName($category_node->text);                        if($category_node->parent == '#'){// wyjątek dla roota kategorii                            $category->setParentid(0);                        }else{                            $category->setParentid($parent_id[$category_node->parent]);                        }                        $this->getObjectManager()->persist($category);                        $this->getObjectManager()->flush();                        $parent_id[$category_node->id] = $category_node->id; //zapisanie noda w tablicy odwzorowania identyfikatorów                        $old_category_index = array_key_exists($category_node->id, $old_categories);//usunięcie noda z tablicy starego drzewa kategorii                        if($old_category_index != NULL){                            unset($old_categories[$category_node->id]);                            //die(var_dump('wyciete'.$old_category_index));                        }                    }else{                        $category = new Categories();                        $category   ->setName($category_node->text)                                    ->setParentid($parent_id[$category_node->parent])                                    ->setIdproducttypes($product_type);                        $this->getObjectManager()->persist($category);                        $this->getObjectManager()->flush();                        $parent_id[$category_node->id] = $category->getId(); //zapisanie noda w tablicy odwzorowania identyfikatorów                    }                }                //usunięcie kategorii nie przesłanych w nowym formularzu                foreach($old_categories as $key => $value){                    //die(var_dump($old_categories));                    $category = $this->getObjectManager()->getRepository('\Application\Entity\Categories')->findOneById($old_categories[$key]->id);                    $this->getObjectManager()->remove($category);                    $this->getObjectManager()->flush();                }            }            return $this->redirect()->toRoute('products-type', array());        }            /////////////////////////////////////            ///return form with present data////            ////////////////////////////////////            $id = (int)$this->getEvent()->getRouteMatch()->getParam('id');            $product_type = $this->getObjectManager()->getRepository('\Application\Entity\ProductTypes')->findOneById($id);            /**             *  NAME OF TYPE OF PRODUCT             */            $form->get('id')->setValue($product_type->getId());            $form->get('name')->setValue($product_type->getName());            /**             * ATTRIBUTES             */            $attributes_groups = $this->getObjectManager()->getRepository('\Application\Entity\AttributesGroups')->findBy(array('idProductType' => $id));            $atributes_active = array();            foreach ($attributes_groups as $key => $value) {                $atributes_active[] = $attributes_groups[$key]->getIdAttributes()->getId();            }            $attributes = $this->getObjectManager()->getRepository('\Application\Entity\Attributes')->findAll();            $attr_options = array();            foreach ($attributes as $key => $value) {                $attr_options[$attributes[$key]->getId()] = $attributes[$key]->getName().' ('.$attributes[$key]->getDescription().')';            }            $form->get('attributes')->setAttribute('options', $attr_options);            $form->get('attributes')->setValue($atributes_active);            /**             * DOMAINS             */            $domains_active = explode(";", $product_type->getDomains());            $domains = $this->getObjectManager()->getRepository('\Application\Entity\Domains')->findAll();            $domain_options = array();            foreach ($domains as $key => $value) {                $domain_options[$domains[$key]->getId()] = $domains[$key]->getName();            }            $form->get('domains')->setAttribute('options', $domain_options);            $form->get('domains')->setValue($domains_active);            /**             * IS_CATEGORY             */            $form->get('is_category')->setValue($product_type->getIsCategory());            /**             *  CATEGORIES TREE             */            $categories_tree = $this->get_categories_tree($product_type, false);            $categories_tree = json_encode($categories_tree);            //$this->getServiceLocator()->get('log')->info($categories_table);            $form->get('categories')->setValue($categories_tree);            /**             * VIEWS             */            $qb = $this->getObjectManager();            $query = $qb->createQuery("SELECT Views FROM Application\Entity\Views Views WHERE Views.idProductType = " . $product_type->getId() );            $result_views = $query->getResult();        return new ViewModel(array('form' => $form, 'product_type_id' => $id, 'views' => $result_views));    }    public function deleteAction()    {        $id = (int)$this->getEvent()->getRouteMatch()->getParam('id');        $product_type = $this->getObjectManager()->getRepository('\Application\Entity\ProductTypes')->findOneById($id);        if (!empty($product_type)) {            $product_attributes = $this->getObjectManager()->getRepository('\Application\Entity\AttributesGroups')->findBy(array('idProductType' => $id));            foreach($product_attributes as $item){                $this->getObjectManager()->remove($item);            }            if($product_type->getIsCategory()){                $categories = $this->getObjectManager()->getRepository('\Application\Entity\Categories')->findBy(array('idproducttypes' => $id));                foreach($categories as $item){                    $this->getObjectManager()->remove($item);                }            }            $this->getObjectManager()->remove($product_type);            $this->getObjectManager()->flush();        }        return $this->redirect()->toRoute('products-type', array());    }	protected function getObjectManager()    {        if (!$this->_objectManager) {            $this->_objectManager = $this->getServiceLocator()->get('Doctrine\ORM\EntityManager');        }        return $this->_objectManager;    }    protected function get_categories_tree($productTypeId, $is_index = NULL){        $categories = $this->getObjectManager()->getRepository('\Application\Entity\Categories')->findBy(array('idproducttypes' => $productTypeId->getId()));        $categories_table = array();        if($is_index){//tablica z indeksami dla potrzeb akcji edycji            foreach($categories as $key => $value){                if( $value->getParentid() == 0){                    $categories_table[$value->getId()] = (object) array(    'id' => $value->getId(),                                                                            'parent' => '#',                                                                            'text' => $value->getName(),                                                                    );                }else{                    $categories_table[$value->getId()] = (object) array( 'id' => $value->getId(),                        'parent' => $value->getParentid(),                        'text' => $value->getName(),                    );                }            }        }else{            foreach($categories as $key => $value){                if( $value->getParentid() == 0){                    $categories_table[] = (object) array(    'id' => $value->getId(),                        'parent' => '#',                        'text' => $value->getName(),                    );                }else{                    $categories_table[] = (object) array( 'id' => $value->getId(),                        'parent' => $value->getParentid(),                        'text' => $value->getName(),                    );                }            }        }        return $categories_table;    }}